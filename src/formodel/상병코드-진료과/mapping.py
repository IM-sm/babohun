import pandas as pd

file_path = 'new_merged_data/df_result2.csv'
df = pd.read_csv(file_path)

# 진료과 맵핑
seoul_department = [
    '내과', '소아청소년과', '신경과', '정신건강의학과', '피부과', '가정의학과', '응급의학과',
    '영상의학과', '방사선종양학과', '진단검사의학과', '병리과', '핵의학과', '건강관리과', '한의과',
    '외과', '흉부외과', '정형외과', '신경외과', '성형외과', '산부인과', '안과', '이비인후과',
    '비뇨의학과', '마취통증의학과', '보철과', '구강악안면외과', '보존과', '치주과', '구강내과',
    '통합치의학과', '재활센터'
]

busan_department = [
    '내과', '소아청소년과', '신경과', '정신건강의학과', '피부과', '가정의학과', '영상의학과',
    '진단검사의학과', '병리과', '한의과', '응급의학과', '외과', '정형외과', '신경외과',
    '산부인과', '안과', '이비인후과', '비뇨의학과', '치과', '마취통증의학과', '재활센터'
]

gwangju_department = [
    '내과', '소아청소년과', '신경과', '정신건강의학과', '피부과', '가정의학과', '건강관리과',
    '영상의학과', '진단검사의학과', '병리과', '한의과', '응급의학과', '핵의학과',
    '외과', '정형외과', '신경외과', '산부인과', '안과', '이비인후과', '비뇨의학과',
    '치과', '마취통증의학과', '재활센터'
]

daejeon_department = [
    '내과', '소아청소년과', '신경과', '정신건강의학과', '피부과', '가정의학과',
    '영상의학과', '진단검사의학과', '한의과', '응급의학과',
    '외과', '정형외과', '신경외과', '산부인과', '안과', '이비인후과',
    '비뇨의학과', '치과', '마취통증의학과', '재활센터'
]

daegu_department = [
    '내과', '소아청소년과', '신경과', '정신건강의학과', '피부과', '재활의학과',
    '가정의학과', '영상의학과', '핵의학과', '진단검사의학과', '한의과', '응급의학과',
    '외과', '흉부외과', '정형외과', '신경외과', '산부인과', '안과',
    '이비인후과', '비뇨의학과', '치과', '마취통증의학과'
]

incheon_department = [
    '일반내과', '소화기내과', '호흡기내과', '순환기내과', '내분비내과', '신경과',
    '외과', '정형외과', '신경외과', '안과', '이비인후과', '피부과', '비뇨의학과',
    '재활의학과', '마취통증의학과', '영상의학과', '진단검사의학과',
    '가정의학과', '치과', '응급의학과'
]

department_mapping = {
    '내과': '내과',
    '일반내과':'내과',
    '소화기내과': '내과',
    '호흡기내과': '내과',
    '순환기내과': '내과',
    '내분비내과': '내과',
    '소아청소년과': '소아청소년과',
    '신경과': '신경과',
    '정신건강의학과': '정신건강의학과',
    '피부과': '피부과',
    '가정의학과': '가정의학과',
    '응급의학과': '응급의학과',
    '영상의학과': '영상의학과',
    '방사선종양학과': '방사선종양학과',
    '진단검사의학과': '진단검사의학과',
    '병리과': '병리과',
    '핵의학과': '핵의학과',
    '건강관리과': '건강관리과',
    '한의과': '한의과',
    '외과': '외과',
    '흉부외과': '흉부외과',
    '정형외과': '정형외과',
    '신경외과': '신경외과',
    '성형외과': '성형외과',
    '산부인과': '산부인과',
    '안과': '안과',
    '이비인후과': '이비인후과',
    '비뇨의학과': '비뇨의학과',
    '마취통증의학과': '마취통증의학과',
    '치과':'치과',
    '보철과': '치과',
    '구강악안면외과': '치과',
    '보존과': '치과',
    '치주과': '치과',
    '구강내과': '치과',
    '통합치의학과': '치과',
    '재활센터': '재활의학과',
    '재활의학과':'재활의학과'
}

def icd_to_tuple(code):
    code = str(code).strip()  # 문자열 변환 + 공백 제거
    try:
        return (ord(code[0]), int(code[1:]))
    except (IndexError, ValueError):
        return None

# 상병코드에 따른 진료과 맵핑
icd_ranges = [
    # 특정 감염성 및 기생충성 질환
    ('A00', 'A09', ['내과']),
    ('A15', 'A19', ['내과', '흉부외과']),                    # 대표: 내과
    ('A20', 'A49', ['내과']),
    ('A50', 'A64', ['내과', '비뇨의학과', '산부인과']),       # 대표: 내과
    ('A65', 'A69', ['내과']),
    ('A70', 'A74', ['내과', '비뇨의학과']),                  # 대표: 내과
    ('A75', 'A79', ['내과']),
    ('A80', 'A89', ['내과', '신경과']),                      # 대표: 내과 (순서 변경)
    ('A92', 'A99', ['내과']),
    ('B00', 'B09', ['피부과']),
    ('B15', 'B34', ['내과']),
    ('B20', 'B24', ['내과']),
    ('B35', 'B49', ['내과', '피부과']),                      # 대표: 내과 (순서 변경)
    ('B50', 'B99', ['내과']),

    # 신생물
    ('C00', 'C14', ['외과']),
    ('C15', 'C26', ['내과', '외과']),                        # 대표: 내과
    ('C30', 'C39', ['흉부외과']),
    ('C40', 'C41', ['정형외과']),
    ('C43', 'C44', ['피부과']),
    ('C45', 'C50', ['외과', '유방외과', '흉부외과']),          # 대표: 외과
    ('C51', 'C58', ['산부인과']),
    ('C60', 'C63', ['비뇨의학과']),
    ('C64', 'C68', ['비뇨의학과']),
    ('C69', 'C72', ['신경외과', '안과', '신경과']),            # 대표: 신경외과
    ('C73', 'C97', ['내과']),
    ('D00', 'D48', ['외과']),

    # 혈액 및 조혈기관의 질환과 면역매커니즘을 침범한 특정 장애
    ('D50', 'D89', ['내과']),

    # 내분비, 영양 및 대사 질환
    ('E00', 'E90', ['내과']),

    # 정신 및 행동 장애
    ('F00', 'F99', ['정신건강의학과']),

    # 신경계통의 질환
    ('G00', 'G09', ['내과', '신경과']),                      # 대표: 내과 (순서 변경)
    ('G10', 'G99', ['신경과']),

    # 눈 및 눈 부속기의 질환
    ('H00', 'H59', ['안과']),

    # 귀 및 유돌의 질환
    ('H60', 'H95', ['이비인후과']),

    # 순환계통의 질환
    ('I00', 'I99', ['내과']),

    # 호흡계통의 질환
    ('J00', 'J99', ['내과']),

    # 소화게통의 질환
    ('K00', 'K93', ['내과']),

    # 피부 및 피하조직의 질환
    ('L00', 'L99', ['피부과']),

    # 근골격계통 및 결합조직의 질환
    ('M00', 'M99', ['정형외과']),

    # 비뇨생식계통의 질환
    ('N00', 'N29', ['내과']),
    ('N10', 'N16', ['내과']),
    ('N17', 'N19', ['내과']),
    ('N25', 'N29', ['내과']),
    ('N20', 'N23', ['비뇨의학과']),
    ('N30', 'N39', ['비뇨의학과']),
    ('N40', 'N51', ['비뇨의학과']),
    ('N99', 'N99', ['비뇨의학과']),
    ('N60', 'N64', ['산부인과']),
    ('N70', 'N77', ['산부인과']),
    ('N80', 'N98', ['산부인과']),

    # 임신, 출산 및 산후기
    ('O00', 'O99', ['산부인과']),

    # 출생전후기에 기원한 특정병태
    ('P00', 'P96', ['산부인과']),

    # 선천기형, 변형 및 염색체 이상
    ('Q00', 'Q07', ['신경과']),
    ('Q10', 'Q18', ['안과', '이비인후과', '성형외과']),          # 대표: 안과
    ('Q20', 'Q28', ['내과']),
    ('Q30', 'Q34', ['내과']),
    ('Q35', 'Q37', ['성형외과']),
    ('Q38', 'Q45', ['내과']),
    ('Q50', 'Q56', ['산부인과']),
    ('Q60', 'Q64', ['비뇨의학과']),
    ('Q65', 'Q79', ['정형외과']),
    ('Q80', 'Q89', ['내과']),
    ('Q90', 'Q99', ['내과']),

    # 달리 분류되지 않은 증상, 징후와 임상 및 검사의 이상소견
    ('R00', 'R09', ['내과', '호흡기내과']),                  # 대표: 내과
    ('R10', 'R19', ['소화기내과']),
    ('R20', 'R23', ['피부과']),
    ('R25', 'R29', ['신경과', '정형외과']),                  # 대표: 신경과
    ('R30', 'R39', ['비뇨의학과']),
    ('R40', 'R46', ['정신건강의학과']),
    ('R47', 'R49', ['이비인후과']),
    ('R50', 'R69', ['내과']),
    ('R70', 'R79', ['내과']),
    ('R80', 'R89', ['진단검사의학과']),
    ('R90', 'R94', ['영상의학과']),
    ('R95', 'R99', ['내과']),

    # 손상, 중독 및 와인에 의한 특정 기타 결과
    ('S00', 'S99', ['외과']),
    ('T80', 'T98', ['외과', '내과']),                        # 대표: 외과

    # 질병이환 및 사망의 외인
    ('V01', 'X59', ['응급의학과', '외과', '정형외과']),       # 대표: 응급의학과
    ('X60', 'X84', ['정신건강의학과']),
    ('X85', 'Y09', ['응급의학과']),
    ('Y10', 'Y34', ['응급의학과']),
    ('Y35', 'Y36', ['응급의학과']),
    ('Y40', 'Y59', ['내과']),
    ('Y60', 'Y69', ['내과', '외과']),                        # 대표: 내과
    ('Y70', 'Y84', ['외과']),
    ('Y85', 'Y89', ['내과', '외과']),                        # 대표: 내과
    ('Y90', 'Y98', ['내과']),

    # 건강상태 및 보건서비스 접촉에 영향을 주는 요인
    ('Z00', 'Z13', ['가정의학과']),
    ('Z20', 'Z29', ['내과']),
    ('Z30', 'Z39', ['산부인과']),
    ('Z40', 'Z54', ['내과']),
    ('Z55', 'Z65', ['정신건강의학과']),
    ('Z70', 'Z76', ['가정의학과']),
    ('Z80', 'Z99', ['내과']),

    # 특수 목적 코드
    ('U00', 'U18', ['내과']),
    ('U82', 'U85', ['내과']),
    ('U99', 'U99', ['내과']),
    ('U22', 'U32', ['한의과']),
    ('U50', 'U79', ['한의과']),
    ('U95', 'U98', ['한의과']),
]

def in_range(code, start, end):
    c = icd_to_tuple(code)
    s = icd_to_tuple(start)
    e = icd_to_tuple(end)

    if c is None:
        return False  # 잘못된 상병코드는 비교하지 않음

    # 알파벳이 같으면 숫자 비교
    if s[0] == e[0]:
        if c[0] == s[0]:
            return s[1] <= c[1] <= e[1]
        else:
            return False
    # 알파벳이 다르면 사전순 비교
    if s[0] < c[0] < e[0]:
        return True
    if c[0] == s[0]:
        return c[1] >= s[1]
    if c[0] == e[0]:
        return c[1] <= e[1]
    return False

def map_icd_to_department(code):
    for start, end, departments in icd_ranges:
        if in_range(code, start, end):
            # department_mapping을 이용해 통일
            mapped_departments = [department_mapping.get(dep, dep) for dep in departments]
            return list(set(mapped_departments))  # 중복 제거
    return ['미분류']  # 어떤 범위에도 속하지 않으면

# 실제 매핑 적용 (df에 상병코드가 '상병코드' 컬럼에 있을 경우)
df['진료과'] = df['상병코드'].apply(map_icd_to_department)
df['진료과'] = df['진료과'].apply(lambda x: ', '.join(x) if isinstance(x, list) else str(x))

# 예시: 첫 5개 행 확인
print(df[['상병코드', '진료과']].head())

df.to_csv('new_merged_data/df_result2_mapping1.csv', index=False)

